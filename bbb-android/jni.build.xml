<?xml version="1.0" encoding="UTF-8"?>

<project name="bbb-android-jni" basedir="." default="all">
	<property name="ndk.dir" value="../../android-ndk-r4-crystax"/>
	<property name="ndk.build" value="${ndk.dir}/ndk-build"/>
	<property name="bash" value="/bin/bash"/>
	<property name="echo" value="/bin/echo"/>

	<target name="init">
		<copy toDir="obj/local/armeabi/" preservelastmodified="true" failonerror="false">
			<fileset dir="libs/armeabi/" includes="*.so"/>
		</copy>
	</target>

    <target name="clean">
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="obj/"/>
        </delete>      
    </target>

	<macrodef name="build">
		<attribute name="target"/>
		<sequential>
			<exec executable="${echo}" output="jni/Application.mk" >
                <arg value="-e" />
                <arg value="APP_MODULES := @{target}\n" />
                <arg value="APP_OPTIM := release\n" />
                <arg value="APP_CFLAGS := -O3" />
			</exec>
			<exec executable="${ndk.build}"/>
		</sequential>
	</macrodef>
	
	<target name="mconfnative" depends="init">
		<build target="mconfnative"/>
		<antcall target="install"/>
	</target>
	
	<target name="ffmpeg" depends="init">
		<build target="avutil avformat avcodec swscale"/>
		<antcall target="install"/>
	</target>
	
    <target name="iva" depends="init">
        <build target="thread common queue decode"/>
        <antcall target="install"/>
    </target>
    
    <target name="sipdroid" depends="init">
        <build target="OSNetworkSystem speex_jni bv16_jni silkcommon silk8_jni silk16_jni silk24_jni g722_jni gsm_jni"/>
        <antcall target="install"/>
    </target>
    
	<target name="install">
		<copy toDir="libs/armeabi/" preservelastmodified="true">
			<fileset dir="obj/local/armeabi/" includes="*.so"/>
		</copy>
	</target>
	
	<target name="all" depends="ffmpeg,iva,mconfnative,sipdroid"/>
</project>
